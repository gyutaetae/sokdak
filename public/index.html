<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sokdak - 익명 암호화 메신저</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="apple-touch-icon" href="/favicon.svg">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="hero-section">
            <h1>속닥챗</h1>
            <p class="tagline">완벽한 익명성 · 종단간 암호화 · 흔적 없는 소멸</p>
            <p class="subtitle">비밀 대화방을 생성하고 누구에게도 감시받지 않는 대화를 시작하세요</p>
        </div>

        <div class="action-section">
            <div class="card">
                <h2>비밀 대화방 생성</h2>
                <p>고유한 방 이름을 설정하고 QR로 초대하세요</p>
                <input 
                    type="text" 
                    id="createRoomInput" 
                    placeholder="방 이름은 영문, 숫자, -, _ 만 사용할 수 있습니다."
                    maxlength="50"
                >
                <button id="createRoomBtn" class="btn btn-primary">생성하기</button>
            </div>

            <div class="card">
                <h2>대화방 입장</h2>
                <p>초대받은 방 이름을 입력하세요</p>
                <input 
                    type="text" 
                    id="joinRoomInput" 
                    placeholder="방 이름을 입력하세요"
                    maxlength="50"
                >
                <button id="joinRoomBtn" class="btn btn-secondary">입장하기</button>
            </div>
        </div>

        <div class="features">
            <div class="feature">
                <h3>완전한 암호화</h3>
                <p>종단간 암호화로 제3자 접근 불가</p>
            </div>
            <div class="feature">
                <h3>흔적 없는 소멸</h3>
                <p>1초~1분 자동 삭제 타이머</p>
            </div>
            <div class="feature">
                <h3>P2P 직접 연결</h3>
                <p>서버 미경유 직접 전송</p>
            </div>
            <div class="feature">
                <h3>설치 불필요</h3>
                <p>웹 브라우저만 있으면 즉시 사용</p>
            </div>
        </div>

        <div class="info-section">
            <p class="warning">프라이버시 보호: 모든 대화는 서버에 저장되지 않으며, 세션 종료 시 완전히 소멸됩니다. 최대 3명까지 동시 접속 가능합니다.</p>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>📱 QR 코드로 모바일 초대</h3>
            <p style="color: var(--text-muted); margin: 10px 0;">휴대폰 카메라로 스캔하세요</p>
            <div id="qrcode" style="display: flex; justify-content: center; margin: 20px 0;"></div>
            <p class="room-url" id="roomURL" style="word-break: break-all; font-size: 0.85rem; color: var(--text-muted); margin: 15px 0;"></p>
            <button id="copyURLBtn" class="btn btn-primary" style="margin-bottom: 10px;">URL 복사</button>
            <button id="enterRoomBtn" class="btn btn-secondary">방 입장하기</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        const socket = io();
        
        // 현재 접속 URL 사용 (QR 코드에 현재 링크 사용)
        let serverURL = window.location.origin;
        fetch('/api/server-info')
            .then(res => res.json())
            .then(data => {
                // 서버에서 반환한 URL이 현재 접속 URL과 다르면 현재 URL 우선 사용
                const currentOrigin = window.location.origin;
                const serverOrigin = data.url.split(':').slice(0, 2).join(':') + (data.url.includes(':3000') ? ':3000' : '');
                
                // 현재 접속 URL 사용 (공개 도메인/IP인 경우)
                if (currentOrigin !== 'http://localhost:3000' && !currentOrigin.includes('127.0.0.1') && !currentOrigin.includes('192.168.')) {
                    serverURL = currentOrigin;
                } else {
                    // 로컬 접속인 경우 서버에서 반환한 URL 사용
                    serverURL = data.url;
                }
                console.log('서버 URL:', serverURL);
            })
            .catch(() => {
                console.log('로컬 접속:', serverURL);
            });
        
        // 방 만들기
        document.getElementById('createRoomBtn').addEventListener('click', () => {
            const roomId = document.getElementById('createRoomInput').value.trim();
            
            if (!roomId) {
                alert('방 이름을 입력해주세요.');
                return;
            }
            
            if (!/^[a-zA-Z0-9-_]+$/.test(roomId)) {
                alert('방 이름은 영문, 숫자, -, _ 만 사용할 수 있습니다.');
                return;
            }
            
            window.location.href = `/room.html?room=${roomId}&create=true`;
        });
        
        // 방 입장하기
        document.getElementById('joinRoomBtn').addEventListener('click', () => {
            const roomId = document.getElementById('joinRoomInput').value.trim();
            
            if (!roomId) {
                alert('방 이름을 입력해주세요.');
                return;
            }
            
            // 방 페이지로 이동
            window.location.href = `/room.html?room=${roomId}`;
        });
        
        // Enter 키 이벤트
        document.getElementById('createRoomInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('createRoomBtn').click();
            }
        });
        
        document.getElementById('joinRoomInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('joinRoomBtn').click();
            }
        });
        
        // QR 코드 표시
        let currentRoomId = '';
        function showQRCode(roomId) {
            currentRoomId = roomId;
            const roomURL = `${serverURL}/room.html?room=${roomId}&create=true`;
            document.getElementById('roomURL').textContent = roomURL;
            
            const qrcodeContainer = document.getElementById('qrcode');
            qrcodeContainer.innerHTML = '';
            new QRCode(qrcodeContainer, {
                text: roomURL,
                width: 256,
                height: 256,
                colorDark: "#8b5cf6",
                colorLight: "#ffffff"
            });
            
            document.getElementById('qrModal').style.display = 'flex';
        }
        
        // QR 모달 닫기
        document.querySelector('.close-modal').addEventListener('click', () => {
            document.getElementById('qrModal').style.display = 'none';
        });
        
        document.getElementById('qrModal').addEventListener('click', (e) => {
            if (e.target.id === 'qrModal') {
                document.getElementById('qrModal').style.display = 'none';
            }
        });
        
        // URL 복사
        document.getElementById('copyURLBtn').addEventListener('click', () => {
            const roomURL = document.getElementById('roomURL').textContent;
            navigator.clipboard.writeText(roomURL).then(() => {
                alert('URL이 복사되었습니다! 다른 사람에게 공유하세요.');
            });
        });
        
        // 방 입장하기
        document.getElementById('enterRoomBtn').addEventListener('click', () => {
            window.location.href = `/room.html?room=${currentRoomId}&create=true`;
        });
    </script>
</body>
</html>



